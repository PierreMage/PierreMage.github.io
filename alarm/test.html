<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alarm Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #testLog {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ðŸ§ª Interval Alarm Test Suite</h1>
    
    <div class="test-section">
        <h2>Basic Functionality Tests</h2>
        <button onclick="testBasicFunctionality()">Run Basic Tests</button>
        <div id="basicResults"></div>
    </div>
    
    <div class="test-section">
        <h2>Background Tab Simulation</h2>
        <p>This test simulates background tab behavior by manually triggering visibility changes.</p>
        <button onclick="testBackgroundTab()">Test Background Tab Behavior</button>
        <div id="backgroundResults"></div>
    </div>
    
    <div class="test-section">
        <h2>Audio System Test</h2>
        <button onclick="testAudio()">Test Audio System</button>
        <div id="audioResults"></div>
    </div>
    
    <div class="test-section">
        <h2>Quick Alarm Test (30 seconds)</h2>
        <p>Sets a 1-minute interval alarm and waits 30 seconds to see if timing is accurate.</p>
        <button onclick="testQuickAlarm()" id="quickTestBtn">Start Quick Test</button>
        <div id="quickResults"></div>
    </div>
    
    <div class="test-section">
        <h2>Test Log</h2>
        <button onclick="clearLog()">Clear Log</button>
        <div id="testLog"></div>
    </div>

    <!-- Include the alarm script -->
    <script src="script.js"></script>
    
    <script>
        let testAlarm = null;
        let testStartTime = null;
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('testLog');
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[TEST] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }
        
        function showResult(containerId, message, isPass) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${isPass ? 'pass' : 'fail'}`;
            div.textContent = message;
            container.appendChild(div);
        }
        
        function showInfo(containerId, message) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'test-result info';
            div.textContent = message;
            container.appendChild(div);
        }
        
        function testBasicFunctionality() {
            const container = document.getElementById('basicResults');
            container.innerHTML = '';
            
            log('Starting basic functionality tests...');
            
            // Test 1: Check if IntervalAlarm class exists
            try {
                const alarm = new IntervalAlarm();
                showResult('basicResults', 'âœ“ IntervalAlarm class instantiated successfully', true);
                log('IntervalAlarm class test passed');
                
                // Test 2: Check if required methods exist
                const requiredMethods = ['startAlarm', 'stopAlarm', 'triggerAlarm', 'playBeep', 'handleVisibilityChange'];
                let methodsExist = true;
                
                requiredMethods.forEach(method => {
                    if (typeof alarm[method] !== 'function') {
                        showResult('basicResults', `âœ— Method ${method} not found`, false);
                        methodsExist = false;
                        log(`Method ${method} test failed`);
                    }
                });
                
                if (methodsExist) {
                    showResult('basicResults', 'âœ“ All required methods exist', true);
                    log('Methods existence test passed');
                }
                
                // Test 3: Check initial state
                if (!alarm.isActive && alarm.intervalMinutes > 0) {
                    showResult('basicResults', 'âœ“ Initial state is correct', true);
                    log('Initial state test passed');
                } else {
                    showResult('basicResults', 'âœ— Initial state is incorrect', false);
                    log('Initial state test failed');
                }
                
            } catch (error) {
                showResult('basicResults', `âœ— Failed to instantiate IntervalAlarm: ${error.message}`, false);
                log(`Basic functionality test failed: ${error.message}`);
            }
        }
        
        function testBackgroundTab() {
            const container = document.getElementById('backgroundResults');
            container.innerHTML = '';
            
            log('Starting background tab simulation test...');
            
            try {
                const alarm = new IntervalAlarm();
                
                // Simulate starting an alarm
                alarm.isActive = true;
                alarm.intervalMinutes = 5;
                alarm.secondsUntilAlarm = 300; // 5 minutes
                
                showInfo('backgroundResults', 'Simulating tab going to background...');
                log('Simulating visibility change...');
                
                // Simulate visibility change
                alarm.handleVisibilityChange();
                
                showResult('backgroundResults', 'âœ“ Visibility change handled without errors', true);
                log('Background tab simulation test passed');
                
            } catch (error) {
                showResult('backgroundResults', `âœ— Background tab test failed: ${error.message}`, false);
                log(`Background tab test failed: ${error.message}`);
            }
        }
        
        async function testAudio() {
            const container = document.getElementById('audioResults');
            container.innerHTML = '';
            
            log('Starting audio system test...');
            
            try {
                const alarm = new IntervalAlarm();
                
                showInfo('audioResults', 'Testing audio system (you should hear beeps)...');
                log('Testing audio playback...');
                
                await alarm.playBeep(true);
                
                showResult('audioResults', 'âœ“ Audio test completed (check console for any errors)', true);
                log('Audio test completed');
                
            } catch (error) {
                showResult('audioResults', `âœ— Audio test failed: ${error.message}`, false);
                log(`Audio test failed: ${error.message}`);
            }
        }
        
        function testQuickAlarm() {
            const container = document.getElementById('quickResults');
            const btn = document.getElementById('quickTestBtn');
            container.innerHTML = '';
            
            log('Starting quick alarm test...');
            
            try {
                // Create a test alarm with 1-minute interval
                testAlarm = new IntervalAlarm();
                testAlarm.intervalMinutes = 1;
                testStartTime = Date.now();
                
                // Override triggerAlarm to capture when it fires
                const originalTrigger = testAlarm.triggerAlarm.bind(testAlarm);
                testAlarm.triggerAlarm = async function() {
                    const elapsed = Date.now() - testStartTime;
                    const expectedTime = 60000; // 1 minute
                    const tolerance = 2000; // 2 second tolerance
                    
                    log(`Quick alarm triggered after ${elapsed}ms (expected ~${expectedTime}ms)`);
                    
                    if (Math.abs(elapsed - expectedTime) <= tolerance) {
                        showResult('quickResults', `âœ“ Alarm triggered accurately (${elapsed}ms, expected ${expectedTime}ms)`, true);
                    } else {
                        showResult('quickResults', `âœ— Alarm timing inaccurate (${elapsed}ms, expected ${expectedTime}ms)`, false);
                    }
                    
                    // Call original trigger
                    await originalTrigger();
                    
                    // Clean up
                    testAlarm.stopAlarm();
                    btn.disabled = false;
                    btn.textContent = 'Start Quick Test';
                };
                
                // Calculate next alarm time (next minute boundary)
                testAlarm.calculateNextAlarmTime();
                
                // Start the alarm
                testAlarm.startAlarm();
                
                btn.disabled = true;
                btn.textContent = 'Test Running...';
                
                showInfo('quickResults', 'Quick test started - alarm should trigger at the next minute boundary');
                log('Quick alarm test started');
                
            } catch (error) {
                showResult('quickResults', `âœ— Quick alarm test failed: ${error.message}`, false);
                log(`Quick alarm test failed: ${error.message}`);
                btn.disabled = false;
                btn.textContent = 'Start Quick Test';
            }
        }
        
        // Initialize logging
        document.addEventListener('DOMContentLoaded', () => {
            log('Test suite loaded');
            
            // Request notification permission for testing
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    log(`Notification permission: ${permission}`);
                });
            }
        });
    </script>
</body>
</html>
